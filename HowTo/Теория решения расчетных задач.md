# Теория расчетных задач

## Отличительные особенности расчетных задач
  
* Отсутствие однозначной привязки событий к точке на оси времени, т.к. регистрируемые события в этом виде учета имеют отношение не к моменту времени, а к периоду в целом
  * Период расчета можно выбирать любой: день, месяц, квартал, год и т.д.
* Протяжённость некоторых регистрируемых событий во времени
  * Н-р: отпуск сотрудника или аренда помещения

## Общая теория

1. Билет по расчетам имеет строгую и не противоречивую логику разбора и выработки решения. Она хорошо изложена в курсе от УЦ 1С. Очень советую его прослушать

2. Виды времени (3 вида):
    * *Календарное время* - всё просто: 365/366 дней по 24 часа
    * *Плановое рабочее время* - сколько вы должны отработать в указанный период: неделю, месяц, квартал и т.д.
    * *Фактически отработанное время* - сколько вы по факту отработали

3. Виды периодов (4 периода):
    * *Период регистрации* - в каком месяце событие зарегистрировано: в марте я регистрирую начисление за март. А могу это событие зарегистрировать и в апреле, но за март.
    * *Период действия (план)* - сколько по плану длится начисление, можно сказать что это то самое плановое время, т.е. те самые 40 часов в неделю.
    * *период действия (факт)* - сколько по факту подлежит начислению в это месяце, т.е. по плану должно было быть 40, но 1 день я отпросился, поэтому остаётся 32 часа
    * *Базовый период* - На базе чего рассчитывать начисление, н-р: "премия считается как % от заработанного в прошлом месяце", вот "прошлый месяц" - это и есть базовый период.

4. Учет фактического времени может вестись двумя вариантами (об этом напрямую будет сказано в билете):
    * *Метод отклонения* - когда события регистрируются в течении учетного периода, а потом, при подсчете результата, получаем результат по данным специально виртуальной таблицы *Данные графика*
    * *Работа по графику* - когда мы вносим данные по факту работы в конце периода регламентным документом, н-р: "График"

5. При построении решения обязательно использовать следующие метаданные (за не использование сразу неуд.):
    * Планы видов расчета
      * в них и происходит вся настройка каждого отдельного вида расчета
      * Все виды расчета нужно заводить предопределёнными
    * Регистры расчета
      * строится на основании планов видов расчёта
        * Всегда будет иметь 1 измерение *Сотрудник* и 1 Ресурс *Результат*, остальное зависит от билета

6. Отчеты в данном виде задач чаще всего строятся по основной таблице регистра
    * Все дополнительные аналитики выносятся в реквизиты, если по условию задачи не следует чего-либо другого
    * Все дополнительные числовые поля, кроме результата расчета так же выносятся в реквизиты (н-р: % премии и трудовой стаж)
    * Раз мы используем основную таблицу регистра, не забываем ставить отбор на активность записей
      * В основной таблице регистра есть признак "Активность" = ЛОЖЬ строка не влияет на виртуальные таблицы

## Методика решения расчетных задач (2 этапа)

* Этап 1 - выяснение сколько и каких видов расчета необходимо создать
  
  * Шаг 1 - выясняем где в задаче описываются виды расчета и выводим формулу расчета для каждого вида
    * Для каждого элемента формулы выясняем
      * Где должно хранится значение элемента формулы
      * Как получить значение элемента формулы
  
  * Шаг 2 - определяем, в какой последовательности реализовывать виды расчета
    * Выяснить это можно только после того, как выявили все виды расчета
      * Последовательность расчета НЕ может быть произвольной
        * С точки зрения платформы последовательность расчета определена программным кодом
        * Необходимости в приоритете чаще всего нет и реализовывать на экзамене не нужно

* Этап 2 - настройка зависимостей между получившимися видами расчета и отметить, если требуется, зависимость по периоду действия
  
  * Составляем следующую таблицу зависимостей

    | Порядок | Вид расчета | Вытесняющий | Базовый | Ведущий  | Учет по периоду действия |
    | :------ | :---------: | :---------: | :-----: | :------: | -----------------------: |
  
  * Например:
    | Порядок | Вид расчета | Вытесняющий | Базовый | Ведущий  | Учет по периоду действия |
    | :------ | :---------: | :---------: | :-----: | :------: | -----------------------: |
    | 1       | **Оклад**   | -           | -       | Х        | +                        |
    | 2       | Премия      |             | ОКЛАД   | Х        | -                        |

  * Как заполнять таблицу?

    * Будет ли вытесняющий вид расчета? Надо проверить 3 обязательных условия
      * Возможность вытеснения следует из постановки задачи или подразумевается сама собой (н-р: прогул)
        * н-р: *В случае получения сотрудником пособия начисление по окладу не производится*
      * Возможно настроить вытеснение только в одну сторону?
        * Подобная настройка влияет непосредственно на результат расчета?
          * Если есть фактическое время и получается через данные графика, тогда влияет
          * Если по табелю - вытеснения нет!

    * Будет ли базовый?
      * Если для вида расчета получаем какую-либо базу - тогда будет

    * Будет ли ведущий?
      * Ведущий связан с механизмом перерасчетов, поэтому если их нет - тогда не будет
        * Н-р: Механизм перерасчетов в рамках данной задачи использовать не надо.

    * Будет ли учет по периоду действия
      * Настраивается в конце, когда определились с зависимостями

## Нюансы

* Нюансы решения задач при использовании метода отклонений
  * Если мы имеем 2 вида расчета с фактическим временем и мы понимаем, что это РАЗНОЕ фактическое время (н-р: время работы и время болезни), тогда для каждого вида расчета мы можем получать данные графика
  * Если же мы имеем 2 вида расчета с фактическим временем и это одинаковое время (н-р: отработанные часы (Оклад) и отработанные дни (Оплата за телефон)) то тогда, фактическое время мы получаем 1 раз, по одному виду расчета, а для второго тогда используем расчет по базе

* У измерения есть флаг "База"; ставится он только у тех измерений, по которым будем считать базу

* Если несколько регистров расчета, то детализация расчетов одинаковая, т.е. Кол-во измерений одно и их состав одно и то же!

* Если необходимо реализовать выплату - он ВСЕГДА реализуется на регистре накопления типа "Остатки" (структура регистра зависит от вида платежной ведомости)
Остатки по виду расчета не детализируются

## Про перерерасчеты
  
* Типовые задачи применения перерасчетов

  |Прикладная задача требующая перерасчетов      | Зависимость, решающая эту задачу |
  | :------------------------------------------- | -------------------------------: |
  |Вытеснение (достаточно заполнения платформой) | Зависимость "вытесняющий"        |
  |Расчет по базе (когда премия это % от оклада) | Зависимость "ведущий"            |

* На экзамене, если есть перерасчеты и расчет по базе, то надо настраивать и ведущий
  * В жизни бывает по разному…
  * Если есть вытеснение - ничего настраивать не надо, т.к. вытесняющий автоматом считает ведущим

## Пример анализа

* Фраза: *Начисление зарплаты сотрудникам предприятия осуществляется ежемесячно с использованием метода отклонений*
  * Позволяют узнать длину периода (ежемесячно) и метод получения данных по фактическому времени (метод отклонений)

* Фраза: *Каждый сотрудник может работать одновременно в нескольких подразделениях компании, то есть совместительство допускается*
  * Позволяет узнать, будет ли подразделение измерением регистра или нет; в этом случае - **будет**
  * Если совместительство не допускается, то Подразделение будет реквизитом

* Фраза: *Все сотрудники работают по пятидневному графику работы, однако в решении необходимо предусмотреть возможность работы по нескольким различным графикам*.
  * Это относится к информации к получению данных графика
  * То, что нужно предусмотреть работу по нескольким графикам говорит о том, что:
    * Графики работы должны быть справочником
    * В регистре сведений "График работы" должно быть измерение "График работы"
      * Может быть измерение "Сотрудник", если есть фраза "каждый сотрудник работает по своему графику"
      * Может быть измерение "Подразделение", если есть фраза "каждое подразделение работает по своему графику"
    * Должна быть возможность указать "График работы" в документе начисление з.п.
    * В регистре расчета должна быть установлена связь с указанными разрезом регистра сведений "График работы"
      * это может быть реквизит "График работы", если добавили измерение "График работы"
      * это может быть измерение "Сотрудник", если добавили измерение "Сотрудник"
      * это может быть измерение/реквизит (в зависимости от условий) "Подразделение", если добавили измерение "Подразделение"
      * и т.д.

* Фраза: *Сотрудники предприятия получают оплату по окладу пропорционально отработанному времени в часах. Часовая ставка рассчитывается как начальное значение оклада, деленное на количество рабочих часов в том же периоде, что и фактически отработанные часы. Первоначальное значение оклада может изменяться не чаще, чем один раз в день, но берется на начало расчетного периода. В информационной базе необходимо хранить историю его изменения.*
  * Вот тут описан вид расчета - **Оклад**
  * Выводим формулу вычисления оклада (ОКЛ)
    * ```ОКЛ = ([Значение Оклада] / [кол-во рабочих часов (план)]) * [кол-во рабочих часов (факт)]```
  * Выводим для каждого элемента формулы или место хранения или способ получения
    * ```[Значение Оклада]``` - хранится в периодическом регистре сведений, а значит получаться будет через *СрезПоследних*
      * ВАЖНЫЙ НЮАНС!
        * Фраза: *Первоначальное значение оклада может изменяться не чаще, чем один раз в день, но берется на начало расчетного периода* НЕ говорит нам о том, что надо использовать периодический период сведений для хранения данных оклада
      * А вот фраза: *В информационной базе необходимо хранить историю его изменения* - как раз на это указывает!
    * ```[кол-во рабочих часов (план)]```
      * Это *Плановое рабочее время*, а значит получается из данных графика
    * ```[кол-во рабочих часов (факт)]```
      * Это *Фактически отработанное время* . Смотрим теорию и видим, что фактическое время, при методе отклонений, так же получается из данных графика

* Фраза: *В случае болезни сотрудник получает пособие, размер которого определяется как количество дней болезни, умноженное на дневную ставку. Дневная ставка едина для всех сотрудников компании и должна быть зафиксирована в информационной базе. Дни болезни сотрудника рассчитываются по пятидневному графику. В случае получения сотрудником пособия начисление по окладу не производится*
  * Вот тут описан вид расчета - **Больничный**
  * Выводим формулу вычисления больничного (БЛН):
    * ```БЛН = [Дневная ставка] * [Дней болезни]```
  * Выводим для каждого элемента формулы место хранения и/или способ получения
    * ```[Дневная ставка]``` - может быть константа (нет информ. По истории)
      * Дневная ставка едина для всех сотрудников компании и должна быть зафиксирована в информационной базе
        * Раз едина для всех в компании, то используем константу
    * ```[Дней болезни]``` - данные график (важно, что это данные по пятидневному графику!)

* Приоритет расчетов
  * Возможно ли начинать расчет с расчета оклада? - исходя из условий наши виды расчета НЕ зависят друг от друга, поэтому можно

* Таблица расчетов
    | Порядок | Вид расчета | Вытесняющий | Базовый | Ведущий  | Учет по периоду действия |
    | :------ | :---------: | :---------: | :-----: | :------: | -----------------------: |
    | 1       | Оклад       | Больничный  | -       | Х        | +                        |
    | 2       | Больничный  | -           | -       | Х        | +                        |

* Фраза: *Следует учесть, что данные о болезни могут вводиться в систему задним числом*.
  * Значит нам необходимо использовать механизм "Дополнений" и "сторнирование"!

* Фраза: *Механизм перерасчетов в рамках данной задачи использовать не надо*.
  * Значит признака "Ведущий" ни у кого не будет и этой колонкой можно пренебречь!
